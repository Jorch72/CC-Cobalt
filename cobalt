cobalt = {
	graphics = { },
	filesystem = { },
	event = { },
	window = { },
	_mainloop = true,
	keyboard = {
		keysdown = { },
	},
	rednet = {

	},
	application = {
		backColour = colours.black,
		foreColour = colours.white,
	},
	math = { },
	mouse = { },
	table = { },
	state = "Main",
	version = "1.1_0",
	updatespeed = 0.1
}

cobalt.surface = dofile( "cobalt-lib/surface" )

cobalt.updatetimer = os.startTimer( cobalt.updatespeed )

function cobalt.debug( item )
	local f = fs.open( ".cobaltdebug", "w" )
	f.write(item)
	f.close()
	cobalt.exit()
end


local function getFile( file, path )
	local dl = http.get( "https://raw.githubusercontent.com/ebernerd/Cobalt/master/"..file )
	if dl then
		local h = dl.readAll()
		dl.close()
		return h
	end
	return false
end

local args = { ... }
if args[1] == "version" then
	print( "Cobalt " .. cobalt.version )
	v = getFile( "version" )
	if v then
		if cobalt.version ~= v then
			print( "Your Cobalt version is out of date!\nYour Version: " .. cobalt.version .. " | Current: " .. v )
			print( "\nUse the command \"cobalt update\" to receive the newest update!" )
		end
	else
		print( "Cobalt version checking is not available at this time" )
	end
elseif args[1] == "update" then
	shell.run( "pastebin run h5h4fm3t" )
elseif args[1] == "help" then
	print( "You can find help resources here: ")
	print( "https://github.com/ebernerd/Cobalt/wiki")
elseif args[1] == "examples" then
	if fs.isDir( "cobalt-examples" ) then
		if args[2] then
			if fs.exists( "cobalt-examples/" .. args[2] ) then
				shell.run( "cobalt-examples/" .. args[2] )
			else
				print( "List of Cobalt examples: ")
				for i, v in pairs( fs.list( "cobalt-examples" ) ) do
					print( "-" .. v )
				end
			end
		else
			print( "List of Cobalt examples: ")
			for i, v in pairs( fs.list( "cobalt-examples" ) ) do
				print( "-" .. v )
			end
		end
	else
		print( "Download the Cobalt examples here" )
		print( "http://github.com/ebernerd")
	end
end

cobalt.g = cobalt.graphics
cobalt.k = cobalt.keyboard
cobalt.fs = cobalt.filesystem
cobalt.e = cobalt.event
cobalt.w = cobalt.window
cobalt.m = cobalt.mouse

local graphics_lighten = {
	[colours.black] = colours.grey,
	[colours.grey] = colours.lightGrey,
	[colours.lightGrey] = colours.white,
	[colours.white] = colours.white,

	[colours.blue] = colours.cyan,
	[colours.cyan] = colours.lightBlue,
	[colours.lightBlue] = colours.white,

	[colours.green] = colours.lime,
	[colours.lime] = colours.white,

	[colours.brown] = colours.orange,
	[colours.orange] = colours.yellow,
	[colours.yellow] = colours.white,

	[colours.red] = colours.pink,
	[colours.pink] = colours.white,

	[colours.purple] = colours.magenta,
	[colours.magenta] = colours.white,

}

local graphics_darken = {
	[colours.white] = colours.lightGrey,
	[colours.lightGrey] = colours.grey,
	[colours.grey] = colours.grey,

	[colours.lightBlue] = colours.cyan,
	[colours.cyan] = colours.blue,

	[colours.lime] = colours.green,

	[colours.yellow] = colours.orange,
	[colours.orange] = colours.brown,

	[colours.pink] = colours.red,
	[colours.magenta] = colours.purple,
}

--[=[ GRAPHICS FUNCTIONS ]=]--
function cobalt.graphics.print( text, x, y, colour, backColour )
	text = tostring(text) or "Some Text"
	if cobalt.application.view then
		cobalt.application.view:drawText( cobalt.math.round(x), cobalt.math.round(y), text, colour, backColour )
	end
end
function cobalt.graphics.rect( mode, x, y, w, h, colour )
	if cobalt.application.view then
		if mode == "fill" then
			cobalt.application.view:fillRect( cobalt.math.round(x), cobalt.math.round(y), cobalt.math.round(w+x), cobalt.math.round(h+y), " ", colour )
		elseif mode == "line" then
			cobalt.application.view:drawRect( cobalt.math.round(x), cobalt.math.round(y), cobalt.math.round(w+x), cobalt.math.round(h+y), " ", colour )
		end
	end
end
function cobalt.graphics.center( text, y, offset, colour, backColour )
	text = tostring(text) or "Some Text"
	y = y or 1
	offset = offset or 0
	if cobalt.application.view then
		local t = {}
		for i in string.gmatch( text, "%S+" ) do
			t[#t+1] = i
		end
		local lines = {[1] = ""}
		local line = 1
		for i=1, #t do
			if #tostring(lines[line].." "..t[i]) > cobalt.window.getWidth() then
				lines[line] = lines[line] .. "\n"
				line = line + 1
				lines[line] = " " .. t[i]
			else
				lines[line] = lines[line] .. " " .. t[i]
			end
		end
		y = y or math.ceil(dy/2-#lines/2)
		for i = 1, #lines do
			cobalt.application.view:drawText( cobalt.math.round(cobalt.window.getWidth()/2-#lines[i]/2), cobalt.math.round(y+(i-1)), lines[i], colour, backColour )
		end
	end
end

cobalt.graphics.rectangle = cobalt.graphics.rect

function cobalt.graphics.pixel( x, y, colour )
	--if cobalt.application.view then
		cobalt.application.view:drawPixel( cobalt.math.round(x), cobalt.math.round(y), " ", colour, colour )
	--end
end

function cobalt.graphics.line( x1, y1, x2, y2, backColour, colour )
	if cobalt.application.view then
		cobalt.application.view:drawLine( cobalt.math.round(x1), cobalt.math.round(y1), cobalt.math.round(x2), cobalt.math.round(y2), " ", backColour, colour )
	end
end

cobalt.graphics.setBackgroundColour = term.setBackgroundColour
cobalt.graphics.setColour = term.setTextColour

function cobalt.graphics.lighten( colour )
	return graphics_lighten[colour]
end

function cobalt.graphics.darken( colour )
	return graphics_darken[colour]
end


--[=[WINDOW FUNCTIONS]=]--
function cobalt.window.getWidth()
	local x, _ = term.getSize()
	return x
end

function cobalt.window.getHeight()
	local _, y = term.getSize()
	return y
end

cobalt.window.getSize = term.getSize

--[=[ MOUSE FUNCTIONS ]=]--
function cobalt._mousepressed( x, y, button )
	cobalt.mouse[button] = true

	if cobalt.mousepressed then cobalt.mousepressed( x, y, button ) end
end

function cobalt._mousereleased( x, y, button )
	cobalt.mouse[button] = false

	if cobalt.mousereleased then cobalt.mousereleased( x, y, button ) end
end

function cobalt.mouse.isDown( button )
	return cobalt.mouse[button]
end


--[=[KEYBOARD FUNCTIONS]=]--
function cobalt._keypressed( key, keycode )
	cobalt.keyboard.keysdown[key] = true
	cobalt.keyboard.keysdown[keycode] = true

	if cobalt.keypressed then cobalt.keypressed( key, keycode ) end
end

function cobalt._keyreleased( key, keycode )
	cobalt.keyboard.keysdown[key] = nil
	cobalt.keyboard.keysdown[keycode] = nil

	if cobalt.keyreleased then cobalt.keyreleased( key, keycode ) end
end

function cobalt.keyboard.isDown( key )
	if not key then
		if #cobalt.keyboard.keysdown > 0 then
			return true
		end
	else
		if cobalt.keyboard.keysdown[key] then
			return true
		end
	end
	return false
end


function cobalt.math.round(num, idp)
	local mult = 10^(idp or 0)
	return math.floor(num * mult + 0.5) / mult
end


--[=[REDNET FUNCTIONS]=]--
function cobalt.rednet.receive(time, ret)

end

--[=[STATE FUNCTIONS]=]--
function cobalt.getState()
	return cobalt.state
end

function cobalt.getPercentage( str )
	if type(str) == "string" then
		if str:sub( #str ) == "%" then
			local perc = str:sub( 1, #str-1 )
			perc = tonumber(perc)
			if perc > 100 or perc < 0 then
				error( "Invalid percentage" )
			else
				return perc/100
			end
		else
			error("Expected number or percentage")
		end
	end
end

function cobalt.setPercentage( perc )
	return perc --Dunno if this will work.
end


--[=[FILESYSTEM FUNCTIONS]=]--
cobalt.filesystem.list = fs.list
cobalt.filesystem.getDirectoryItems = fs.list
cobalt.filesystem.isFile = fs.exists
cobalt.filesystem.isDirectory = fs.isDir
--cobalt.filesystem.currentDir = shell.dir()

cobalt.raw = false

function cobalt.exit( ... )
	local msgs = { ... }
	cobalt._mainloop = false
	for i = 1, 10 do
		term.setBackgroundColour(colours.black)
		term.setTextColour( colours.white )
		term.clear()
		term.setCursorPos( 1, 1 )
	end
	if #msgs >= 1 then
		for i =1, #msgs do
			print( msgs[i] )
		end
	end
	return true
end

function cobalt.initLoop( runOnce )
	term.clear()
	term.setCursorPos( 1, 1 )
	cobalt.application.view = cobalt.surface.create( cobalt.window.getWidth(), cobalt.window.getHeight(), " ", cobalt.application.backColour, cobalt.application.foreColour )
	while cobalt._mainloop do

		local e, a, b, c, d, e
		if cobalt.raw then
			e, a, b, c, d, e = os.pullEventRaw()
		else
			e, a, b, c, d, e = os.pullEvent()
		end
		if e == "char" then
			if cobalt.textinput then	cobalt.textinput( a ) end
		elseif e == "key" then
			cobalt._keypressed( a, keys.getName( a ) )
		elseif e == "key_up" then
			cobalt._keyreleased( a, keys.getName( a ) )
		elseif e == "mouse_click" then
			if cobalt.mousepressed then cobalt.mousepressed( b, c, a ) end --b, c, a to keep love.mousepressed syntax as( x, y, button ), not ( button, x, y )
		elseif e == "mouse_up" then
			if cobalt.mousereleased then cobalt.mousereleased( b, c, a ) end
		elseif e == "rednet_message" then
			if cobalt.rednetreceive then cobalt.rednetreceive( a, b, c ) end
		elseif e == "monitor_touch" then
			if cobalt.monitortouch then cobalt.monitortouch( x, y ) else cobalt.mousereleased( x, y ) end
		elseif e == "mouse_drag" then
			if cobalt.mousedrag then cobalt.mousedrag( x, y ) end
		elseif e == "timer" then
			if a == cobalt.updatetimer then
				if cobalt.update then cobalt.update( cobalt.updatespeed ) end
				cobalt.updatetimer = os.startTimer( cobalt.updatespeed )
				if cobalt.draw then if cobalt.application.view then cobalt.application.view:clear(" ", cobalt.application.backColour, cobalt.application.foreColour ); end cobalt.draw(); if cobalt.application.view then cobalt.application.view:render() end end
			end
		end


		if runOnce then cobalt._mainloop = false; return end
	end
end

function cobalt.initOnce()
	cobalt.initLoop( true )
end

cobalt.init = cobalt.initLoop


return cobalt
